<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>üéµ P2P Audio Sync</title>
    
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #001f3f;
            color: white;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            background: #003366;
            padding: 20px;
            border-radius: 15px;
            width: 350px;
            box-shadow: 0px 0px 10px rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        .id-box {
            background: #004080;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .copy-btn {
            background: #ffcc00;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .copy-btn:hover {
            background: #ffaa00;
        }

        .qr-container {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }

        .scan-btn {
            background: #ff6600;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin: 5px 0;
        }

        .scan-btn:hover {
            background: #cc5500;
        }

        #qrScanner {
            width: 250px;
            height: 250px;
            margin: 10px auto;
            display: none;
            border: 2px solid white;
        }

        button {
            background: #0073e6;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin: 5px 0;
        }

        button:hover {
            background: #005bb5;
        }

        .audio-player {
            background: #002850;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0px 0px 10px rgba(0, 255, 255, 0.3);
        }

        audio {
            width: 100%;
            border-radius: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .audio-controls button {
            padding: 12px 25px;
            background: #00cc99;
        }

        .audio-controls button:hover {
            background: #009977;
        }

        #syncStatus {
            margin-top: 10px;
            font-weight: bold;
            font-size: 18px;
            color: #00ff00;
        }

        .connected-devices {
            margin-top: 15px;
            padding: 10px;
            background: #004080;
            border-radius: 10px;
        }

        .device-list {
            list-style: none;
            padding: 0;
        }

        #shareBtn { 
            background: #28a745; 
        }
        #shareBtn:hover { 
            background: #218838; 
        }
        #stopShareBtn { 
            background: #dc3545; 
        }
        #stopShareBtn:hover { 
            background: #c82333; 
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .panel {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <h1>üéµ P2P Audio Sync</h1>
    
    <div class="container">
        <!-- Host Panel -->
        <div class="panel">
            <h2>üéß Host Controls</h2>
            <div class="id-box">
                üîë Your ID: <strong id="myId">Generating ID...</strong>
                <button class="copy-btn" onclick="copyID()">Copy</button>
            </div>
            <div class="qr-container" id="senderQr"></div>
            
            <button onclick="startScreenCapture()" id="shareBtn">
                üé§ Share System Audio
            </button>
            <button onclick="stopScreenCapture()" id="stopShareBtn" style="display:none;">
                ‚èπ Stop Sharing
            </button>
            
            <input type="file" id="audioInput" accept="audio/*" hidden>
            <button onclick="document.getElementById('audioInput').click()">
                üéµ Select Audio File
            </button>
            
            <div class="audio-player">
                <audio id="mainAudio" controls></audio>
                <div class="audio-controls">
                    <button onclick="syncPlayback()" id="playBtn">‚ñ∂ Play</button>
                    <button onclick="pausePlayback()">‚è∏ Pause</button>
                    <button onclick="stopPlayback()">‚èπ Stop</button>
                </div>
            </div>
            <div class="connected-devices">
                <strong>Connected Listeners:</strong>
                <ul id="connectedList" class="device-list"></ul>
            </div>
        </div>

        <!-- Listener Panel -->
        <div class="panel">
            <h2>üë• Listeners</h2>
            <button onclick="startQRScanner()" class="scan-btn">
                üì∑ Scan Host's QR Code
            </button>
            <input type="text" id="manualId" placeholder="Or enter Host ID manually">
            <button onclick="connectToPeer(document.getElementById('manualId').value)">
                Connect Manually
            </button>
            <div id="qrScanner"></div>
            
            <div class="audio-player">
                <audio id="clientAudio" controls></audio>
                <div id="syncStatus">üî¥ Not Connected</div>
            </div>
        </div>
    </div>

    <script>
    const CHUNK_SIZE = 64 * 1024;
    const MAX_PARALLEL_CHUNKS = 5;
    const SYNC_INTERVAL = 5000;
    
    let receivedFiles = new Map();
    let connections = new Map();
    let peer = null;
    let isHost = false;
    let mediaStream = null;
    let mediaSender = null;

    // Initialize PeerJS
    function initializePeer() {
        peer = new Peer({
            config: {'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'turn:numb.viagenie.ca', username: 'webrtc@live.com', credential: 'muazkh' }
            ]},
            debug: 2
        });

        peer.on('open', (id) => {
            document.getElementById('myId').textContent = id;
            new QRCode(document.getElementById('senderQr'), {
                text: id,
                width: 150,
                height: 150,
                colorDark: "#00FF00",
                colorLight: "#FFFFFF",
                correctLevel: QRCode.CorrectLevel.H
            });
        });

        peer.on('connection', (conn) => {
            setupConnection(conn);
            isHost = true;
            updateConnectedDevices();
        });

        peer.on('call', handleIncomingCall);
        peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
            updateSyncStatus('üî¥ Connection Error: ' + err.type);
        });
    }

    // Screen Capture Functions
    async function startScreenCapture() {
        try {
            mediaStream = await navigator.mediaDevices.getDisplayMedia({
                video: false,
                audio: {
                    autoGainControl: false,
                    echoCancellation: false,
                    noiseSuppression: false,
                    sampleRate: 44100
                }
            });
            
            document.getElementById('shareBtn').style.display = 'none';
            document.getElementById('stopShareBtn').style.display = 'inline-block';
            
            const audioElement = document.getElementById('mainAudio');
            audioElement.srcObject = mediaStream;
            
            connections.forEach(conn => {
                const call = peer.call(conn.peer, mediaStream);
                setupCallHandlers(call);
            });
            
        } catch (err) {
            console.error('Error capturing audio:', err);
            alert('Audio sharing failed. Please allow screen capture with audio.');
        }
    }

    function stopScreenCapture() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        document.getElementById('shareBtn').style.display = 'inline-block';
        document.getElementById('stopShareBtn').style.display = 'none';
    }

    function handleIncomingCall(call) {
        call.answer(null);
        call.on('stream', remoteStream => {
            const clientAudio = document.getElementById('clientAudio');
            clientAudio.srcObject = remoteStream;
        });
    }

    function setupCallHandlers(call) {
        call.on('error', err => console.error('Media call error:', err));
    }

    // Connection Setup
    function setupConnection(conn) {
        connections.set(conn.peer, conn);
        conn.on('open', () => {
            console.log('New connection from:', conn.peer);
            updateConnectedDevices();
        });
        
        conn.on('data', handleIncomingData);
        conn.on('close', () => {
            connections.delete(conn.peer);
            updateConnectedDevices();
        });
        conn.on('error', (err) => console.error('Connection error:', err));
    }

    // ... (Rest of the code from previous implementation remains same)
    // Copy ID, QR Scanner, Audio Handling, Sync Functions, etc.
    // These functions remain unchanged from your original code

    // Utility Functions
    function updateSyncStatus(status) {
        document.getElementById('syncStatus').textContent = status || 'üü¢ Synchronized';
    }

    function updateConnectedDevices() {
        const list = document.getElementById('connectedList');
        list.innerHTML = '';
        connections.forEach((_, peerId) => {
            const li = document.createElement('li');
            li.textContent = `Listener: ${peerId.slice(0, 8)}...`;
            list.appendChild(li);
        });
    }

    // Initialize
    window.addEventListener('load', () => {
        console.log('Initializing PeerJS...');
        initializePeer();
    });
    </script>
</body>
</html>
