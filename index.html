<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>üéµ P2P Audio Sync + Futuristic Visualiser</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #000; color: #fff; text-align: center; margin: 0; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
        .panel { background: #003366; padding: 20px; border-radius: 15px; width: 350px; box-shadow: 0px 0px 10px rgba(0,255,255,0.5); }
        .id-box { background: #004080; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 18px; }
        button { border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-size: 16px; font-weight: bold; }
        .copy-btn { background: #ffcc00; } .copy-btn:hover { background: #ffaa00; }
        .scan-btn { background: #ff6600; color: #fff; margin: 5px 0; } .scan-btn:hover { background: #cc5500; }
        .qr-container { margin: 10px 0; display: flex; justify-content: center; padding: 10px; background: #fff; border-radius: 10px; }
        .audio-player { background: #002850; border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0px 0px 10px rgba(0,255,255,0.3); }
        .audio-controls { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .audio-controls button { background: #00cc99; } .audio-controls button:hover { background: #009977; }
        #syncStatus { margin-top: 10px; font-weight: bold; font-size: 18px; color: #0f0; }
        .connected-devices { margin-top: 15px; padding: 10px; background: #004080; border-radius: 10px; }
        .device-list { list-style: none; padding: 0; }
        #visualizer { display: none; }
        #visualizer.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; }
        body.fullscreen { margin: 0; padding: 0; overflow: hidden; background: #000; }
        @media (max-width: 768px) { .container { flex-direction: column; align-items: center; } .panel { width: 90%; } }
    </style>
</head>
<body>
    <h1>üéµ P2P Audio Sync + Futuristic Visualiser</h1>
    <div class="container">
        <div class="panel" id="hostPanel">
            <h2>üéß Host Controls</h2>
            <div class="id-box">üîë Your ID: <strong id="myId">...</strong> <button class="copy-btn" onclick="copyID()">Copy</button></div>
            <div class="qr-container" id="senderQr"></div>
            <input type="file" id="audioInput" accept="audio/*" style="display:none">
            <button onclick="document.getElementById('audioInput').click()">üéµ Select Audio File</button>
            <div class="audio-player">
                <audio id="mainAudio" controls></audio>
                <div class="audio-controls">
                    <button onclick="syncPlayback()" id="playBtn">‚ñ∂ Play</button>
                    <button onclick="pausePlayback()">‚è∏ Pause</button>
                    <button onclick="stopPlayback()">‚èπ Stop</button>
                </div>
            </div>
            <div class="connected-devices"><strong>Connected Listeners:</strong><ul id="connectedList" class="device-list"></ul></div>
        </div>
        <div class="panel" id="listenerPanel">
            <h2>üë• Listener</h2>
            <button class="scan-btn" onclick="startQRScanner()">üì∑ Scan QR</button>
            <input type="text" id="manualId" placeholder="Or enter Host ID">
            <button onclick="connectToPeer(manualId.value)">Connect</button>
            <div id="qrScanner"></div>
            <div class="audio-player">
                <audio id="clientAudio"></audio>
                <canvas id="visualizer"></canvas>
                <div id="syncStatus">üî¥ Not Connected</div>
            </div>
        </div>
    </div>
    <script>
    const CHUNK_SIZE=64*1024, MAX_PARALLEL_CHUNKS=5, SYNC_INTERVAL=5000;
    let peer, connections=new Map(), receivedFiles=new Map(), isHost=false;

    function initializePeer(){ peer=new Peer({debug:2});
        peer.on('open',id=>{ document.getElementById('myId').textContent=id;
            new QRCode(document.getElementById('senderQr'),{text:id,width:150,height:150,colorDark:'#00FF00',colorLight:'#FFF'});
        });
        peer.on('connection',conn=>{ isHost=true; setupConnection(conn); updateConnectedDevices(); });
        peer.on('error',err=>updateSyncStatus('üî¥ '+err.type));
    }
    function setupConnection(conn){
        connections.set(conn.peer,conn);
        conn.on('open',()=>updateConnectedDevices());
        conn.on('data',handleIncomingData);
        conn.on('close',()=>{ connections.delete(conn.peer); updateConnectedDevices(); });
    }
    function copyID(){ navigator.clipboard.writeText(myId.textContent).then(()=>alert('Copied!')); }

    function startQRScanner(){ const qr=document.getElementById('qrScanner'); qr.innerHTML=""; qr.style.display='block';
        const video=document.createElement('video'),canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'); qr.appendChild(video);
        navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{
            video.srcObject=stream; video.play(); (function scan(){ if(!video.videoWidth)return requestAnimationFrame(scan);
                canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0,canvas.width,canvas.height);
                const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
                if(code){ stream.getTracks().forEach(t=>t.stop()); qr.style.display='none'; connectToPeer(code.data); } else requestAnimationFrame(scan);
            })();
        }).catch(()=>{ updateSyncStatus('üî¥ Camera Denied'); qr.style.display='none'; });
    }
    function connectToPeer(id){ if(!id||connections.has(id))return; const conn=peer.connect(id,{reliable:true}); setupConnection(conn); updateSyncStatus('üü° Connecting'); conn.on('open',()=>{ updateSyncStatus('üü¢ Connected'); onBecomeListener(); }); }
    function onBecomeListener(){ hostPanel.style.display='none'; listenerPanel.style.display='none'; const canvas=visualizer, audio=clientAudio;
        canvas.style.display='block'; canvas.classList.add('fullscreen'); canvas.width=innerWidth; canvas.height=innerHeight; document.body.classList.add('fullscreen'); startVisualizer(audio,canvas);
        window.onresize=()=>{ canvas.width=innerWidth; canvas.height=innerHeight; };
    }
    async function transferAudioFile(file){ const id=Date.now()+'-'+Math.random().toString(36).slice(2), total=Math.ceil(file.size/CHUNK_SIZE);
        connections.forEach(c=>c.send({type:'audio-metadata',id,name:file.name,size:file.size,mime:file.type,totalChunks:total}));
        let indices=[...Array(total).keys()]; while(indices.length){ const batch=indices.splice(0,MAX_PARALLEL_CHUNKS); await Promise.all(batch.map(i=>sendChunk(file,i,id))); }
    }
    function sendChunk(file,i,id){ return new Promise(res=>{ const reader=new FileReader(),start=i*CHUNK_SIZE,end=Math.min(start+CHUNK_SIZE,file.size);
            reader.onload=()=>{ connections.forEach(c=>c.send({type:'audio-chunk',id,index:i,data:reader.result})); res(); };
            reader.readAsArrayBuffer(file.slice(start,end)); }); }
    function syncPlayback(){ if(!connections.size)return; mainAudio.play(); clearInterval(window._sync);
        window._sync=setInterval(()=>{ const d={type:'sync',timestamp:Date.now(),currentTime:mainAudio.currentTime,playbackRate:mainAudio.playbackRate}; connections.forEach(c=>c.send(d)); },SYNC_INTERVAL);
    }
    function pausePlayback(){ mainAudio.pause(); clearInterval(window._sync); connections.forEach(c=>c.send({type:'pause',timestamp:Date.now()})); }
    function stopPlayback(){ mainAudio.pause(); mainAudio.currentTime=0; clearInterval(window._sync); connections.forEach(c=>c.send({type:'stop',timestamp:Date.now()})); }
    function handleIncomingData(d){ if(d.type==='audio-metadata')initFile(d); else if(d.type==='audio-chunk')appendChunk(d);
        else if(d.type==='sync')applySync(d); else if(d.type==='pause')pauseClient(); else if(d.type==='stop')stopClient(); }
    function initFile(m){ receivedFiles.set(m.id,{chunks:new Array(m.totalChunks),size:m.size,mime:m.mime,received:0}); }
    function appendChunk(c){ const f=receivedFiles.get(c.id); if(!f)return; f.chunks[c.index]=c.data; f.received+=c.data.byteLength;
        if(f.received>=f.size){ const blob=new Blob(f.chunks,{type:f.mime}); clientAudio.src=URL.createObjectURL(blob); updateSyncStatus('üü¢ Ready'); }}
    function applySync(d){ const a=clientAudio, latency=(Date.now()-d.timestamp)/1000, target=d.currentTime+latency;
        if(Math.abs(a.currentTime-target)>0.1) a.currentTime=target; a.playbackRate=d.playbackRate; if(a.paused) a.play(); updateSyncStatus('üü¢ Synced'); }
    function pauseClient(){ clientAudio.pause(); updateSyncStatus('‚è∏ Paused'); }
    function stopClient(){ clientAudio.pause(); clientAudio.currentTime=0; updateSyncStatus('‚èπ Stopped'); }
    function updateSyncStatus(txt){ syncStatus.textContent=txt; }
    function updateConnectedDevices(){ const ul=connectedList; ul.innerHTML=''; connections.forEach((_,id)=>{ const li=document.createElement('li'); li.textContent='Listener:'+id.slice(0,8)+'...'; ul.appendChild(li); }); }

    // Futuristic Siri-style Visualiser
    function startVisualizer(audioElement, canvas){
        const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const source=audioCtx.createMediaElementSource(audioElement);
        const analyser=audioCtx.createAnalyser();
        analyser.fftSize=256;
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        const bufferLength=analyser.frequencyBinCount;
        const dataArray=new Uint8Array(bufferLength);
        const ctx2d=canvas.getContext('2d');
        let prevAmp=0;
        function draw(){
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            const sum=dataArray.reduce((a,b)=>a+b,0);
            const amp=sum/bufferLength/255;
            prevAmp+=(amp-prevAmp)*0.1;
            const cx=canvas.width/2, cy=canvas.height/2;
            ctx2d.clearRect(0,0,canvas.width,canvas.height);
            const rings=5;
            for(let i=0;i<rings;i++){
                const ratio=0.2+ i*0.15;
                const radius=(Math.min(canvas.width,canvas.height)/2)*ratio + prevAmp*120;
                const grad=ctx2d.createRadialGradient(cx,cy,radius*0.7,cx,cy,radius);
                grad.addColorStop(0,'rgba(0,255,255,0.7)');
                grad.addColorStop(1,'rgba(0,128,255,0.1)');
                ctx2d.strokeStyle=grad;
                ctx2d.lineWidth=10 - i*2;
                ctx2d.beginPath(); ctx2d.arc(cx,cy,radius,0,Math.PI*2); ctx2d.stroke();
            }
        }
        draw();
    }
    window.addEventListener('load',initializePeer);
    audioInput.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f||!f.type.startsWith('audio/'))return alert('Select audio'); transferAudioFile(f); mainAudio.src=URL.createObjectURL(f); });
    </script>
</body>
</html>
