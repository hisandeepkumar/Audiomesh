<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéµ P2P Audio Sync + Fullscreen Visualiser</title>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #001f3f;
      color: white;
      text-align: center;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px;
    }
    .panel {
      background: #003366;
      padding: 20px;
      border-radius: 15px;
      width: 350px;
      box-shadow: 0 0 10px rgba(0,255,255,0.5);
    }
    .id-box { background: #004080; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 18px; }
    .copy-btn, button, .scan-btn { border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .copy-btn { background: #ffcc00; } .copy-btn:hover { background: #ffaa00; }
    .scan-btn { background: #ff6600; color: white; } .scan-btn:hover { background: #cc5500; }
    .audio-player { background: #002850; border-radius: 15px; padding: 20px; box-shadow: 0 0 10px rgba(0,255,255,0.3); }
    .audio-controls { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
    .audio-controls button { background: #00cc99; } .audio-controls button:hover { background: #009977; }
    .connected-devices { margin-top: 15px; background: #004080; padding: 10px; border-radius: 10px; }
    .device-list { list-style: none; padding: 0; }
    #qrScanner { margin: 10px auto; display: none; }
    #visualizer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      background: black;
      z-index: 999;
    }
    @media (max-width: 768px) { .container { flex-direction: column; } .panel { width: 90%; } }
  </style>
</head>
<body>
  <h1>üéµ P2P Audio Sync</h1>
  <div class="container">
    <!-- Host Panel -->
    <div class="panel" id="hostPanel">
      <h2>üéß Host Controls</h2>
      <div class="id-box">
        üîë Your ID: <strong id="myId">Generating...</strong>
        <button class="copy-btn" onclick="copyID()">Copy</button>
      </div>
      <div class="qr-container" id="senderQr"></div>
      <input type="file" id="audioInput" accept="audio/*" hidden>
      <button onclick="document.getElementById('audioInput').click()">Select Audio File</button>
      <div class="audio-player">
        <audio id="mainAudio" controls></audio>
        <div class="audio-controls">
          <button onclick="syncPlayback()">‚ñ∂ Play</button>
          <button onclick="pausePlayback()">‚è∏ Pause</button>
          <button onclick="stopPlayback()">‚èπ Stop</button>
        </div>
      </div>
      <div class="connected-devices">
        <strong>Listeners:</strong>
        <ul id="connectedList" class="device-list"></ul>
      </div>
    </div>

    <!-- Listener Panel -->
    <div class="panel" id="listenerPanel">
      <h2>üë• Listener</h2>
      <button class="scan-btn" onclick="startQRScanner()">Scan Host QR</button>
      <input type="text" id="manualId" placeholder="Or enter Host ID">
      <button onclick="connectToPeer(manualId.value)">Connect</button>
      <div id="qrScanner"></div>
    </div>
  </div>

  <!-- Fullscreen Visualiser -->
  <canvas id="visualizer"></canvas>
  <audio id="clientAudio" hidden></audio>

  <script>
    const CHUNK_SIZE = 64*1024, MAX_PARALLEL=5, SYNC_INTERVAL=5000;
    let peer, connections=new Map(), receivedFiles=new Map();

    function initializePeer() {
      peer = new Peer({ debug:2 });
      peer.on('open', id=>{
        document.getElementById('myId').textContent = id;
        new QRCode(senderQr, { text:id, width:150, height:150, colorDark:'#00FF00', colorLight:'#FFFFFF' });
      });
      peer.on('connection', conn=>setupConnection(conn));
      peer.on('error', err=>console.error(err));
    }

    function setupConnection(conn) {
      connections.set(conn.peer, conn);
      conn.on('open', ()=>{
        updateConnectedList();
        onBecomeListener();
      });
      conn.on('data', data=>handleData(data));
      conn.on('close', ()=>{ connections.delete(conn.peer); updateConnectedList(); });
    }

    function copyID(){ navigator.clipboard.writeText(myId.textContent).then(_=>alert('Copied')); }

    function startQRScanner() {
      qrScanner.style.display='block';
      const video=document.createElement('video'), canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
      qrScanner.appendChild(video);
      navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }).then(stream=>{
        video.srcObject=stream; video.play();
        (function scan(){ if(!video.videoWidth) return requestAnimationFrame(scan);
          canvas.width=video.videoWidth; canvas.height=video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
          if(code){ stream.getTracks().forEach(t=>t.stop()); qrScanner.innerHTML=''; qrScanner.style.display='none'; connectToPeer(code.data); }
          else requestAnimationFrame(scan);
        })();
      }).catch(_=>{ qrScanner.style.display='none'; });
    }

    function connectToPeer(id) {
      if(!id||connections.has(id)) return;
      const conn = peer.connect(id, { reliable:true });
      setupConnection(conn);
      updateSyncStatus('Connecting...');
    }

    function updateConnectedList() {
      connectedList.innerHTML=''; connections.forEach((_,id)=>{
        const li = document.createElement('li'); li.textContent = id; connectedList.appendChild(li);
      });
    }

    document.getElementById('audioInput').addEventListener('change', e=>{
      const file=e.target.files[0]; if(!file) return; mainAudio.src=URL.createObjectURL(file);
      sendFile(file);
    });

    async function sendFile(file){
      const id=Date.now()+'-'+Math.random().toString(36).substr(2);
      const total=Math.ceil(file.size/CHUNK_SIZE);
      connections.forEach(c=>c.send({ type:'audio-metadata', id, size:file.size, mime:file.type, total }));
      const indices=[...Array(total).keys()];
      while(indices.length){
        const batch=indices.splice(0,MAX_PARALLEL);
        await Promise.all(batch.map(i=>sendChunk(file,i,id)));
      }
    }
    function sendChunk(file,i,id){ return new Promise(res=>{
      const reader=new FileReader(), start=i*CHUNK_SIZE,end=Math.min(start+CHUNK_SIZE,file.size);
      reader.onload=()=>{ connections.forEach(c=>c.send({ type:'audio-chunk', id, index:i, data:reader.result })); res(); };
      reader.readAsArrayBuffer(file.slice(start,end));
    }); }

    function handleData(d){
      if(d.type==='audio-metadata'){ receivedFiles.set(d.id,{chunks:[],meta:d}); return; }
      if(d.type==='audio-chunk'){ const f=receivedFiles.get(d.id); f.chunks[d.index]=d.data; if(f.chunks.length===f.meta.total){
        const blob=new Blob(f.chunks,{type:f.meta.mime}); clientAudio.src=URL.createObjectURL(blob); clientAudio.play();
      }}
      if(d.type==='sync'){ const audio=clientAudio; const latency=(Date.now()-d.timestamp)/1000;
        const target=d.currentTime+latency; if(Math.abs(audio.currentTime-target)>0.05) audio.currentTime=target;
        audio.playbackRate=d.playbackRate; audio.paused&&audio.play(); }
      if(d.type==='pause'){ clientAudio.pause(); }
      if(d.type==='stop'){ clientAudio.pause(); clientAudio.currentTime=0; }
    }

    function syncPlayback(){ mainAudio.play(); clearInterval(window._sync);
      window._sync=setInterval(()=>connections.forEach(c=>c.send({
        type:'sync', timestamp:Date.now(), currentTime:mainAudio.currentTime, playbackRate:mainAudio.playbackRate
      })), SYNC_INTERVAL);
    }
    function pausePlayback(){ mainAudio.pause(); clearInterval(window._sync); connections.forEach(c=>c.send({type:'pause'})); }
    function stopPlayback(){ mainAudio.pause(); mainAudio.currentTime=0; clearInterval(window._sync); connections.forEach(c=>c.send({type:'stop'})); }

    function onBecomeListener(){ hostPanel.style.display='none'; listenerPanel.style.display='none';
      const canvas = visualizer;
      canvas.style.display='block'; canvas.width=window.innerWidth; canvas.height=window.innerHeight;
      startVisualizer(clientAudio, canvas);
    }

    function startVisualizer(audio, canvas){
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const src=ctx.createMediaElementSource(audio); const analyser=ctx.createAnalyser(); analyser.fftSize=512;
      src.connect(analyser); analyser.connect(ctx.destination);
      const dataArr=new Uint8Array(analyser.frequencyBinCount);
      const cctx=canvas.getContext('2d');
      function draw(){ requestAnimationFrame(draw); analyser.getByteFrequencyData(dataArr);
        cctx.fillStyle='black'; cctx.fillRect(0,0,canvas.width,canvas.height);
        const barWidth=canvas.width/dataArr.length;
        dataArr.forEach((v,i)=>{ const h=v/255*canvas.height;
          cctx.fillStyle=`hsl(${(i/dataArr.length)*360+(Date.now()/100)%360},100%,50%)`;
          cctx.fillRect(i*barWidth,canvas.height-h,barWidth,h);
        });
      }
      draw();
    }

    window.addEventListener('load', initializePeer);
  </script>
</body>
</html>
