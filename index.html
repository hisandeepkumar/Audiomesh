<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>üéµ P2P Audio Sync</title>
    
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        /* General Styles */
body {
    font-family: Arial, sans-serif;
    background-color: #001f3f;
    color: white;
    text-align: center;
    margin: 0;
    padding: 20px;
}

/* Main Container */
.container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

/* Panels */
.panel {
    background: #003366;
    padding: 20px;
    border-radius: 15px;
    width: 350px;
    box-shadow: 0px 0px 10px rgba(0, 255, 255, 0.5);
    text-align: center;
}

/* ID Box */
.id-box {
    background: #004080;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 15px;
    font-size: 18px;
}

/* Copy Button */
.copy-btn {
    background: #ffcc00;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
}

.copy-btn:hover {
    background: #ffaa00;
}

/* QR Code Container */
.qr-container {
    margin-top: 10px;
    display: flex;
    justify-content: center;
}

/* Scan Button */
.scan-btn {
    background: #ff6600;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    font-size: 16px;
    margin-top: 10px;
}

.scan-btn:hover {
    background: #cc5500;
}

/* Hidden Scanner */
#qrScanner {
    width: 250px;
    height: 250px;
    margin: auto;
    display: none;
    border: 2px solid white;
}

/* File Input Button */
button {
    background: #0073e6;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    font-size: 16px;
    margin-top: 10px;
}

button:hover {
    background: #005bb5;
}

/* Audio Player Styling */
.audio-player {
    background: #002850;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0px 0px 10px rgba(0, 255, 255, 0.3);
}

audio {
    width: 100%;
    border-radius: 10px;
}

/* Audio Controls */
.audio-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    justify-content: center;
    margin-top: 15px;
}

.audio-controls button {
    width: auto;
    padding: 12px 25px;
    background: #00cc99;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 8px;
    font-size: 16px;
}

.audio-controls button:hover {
    background: #009977;
}

/* Sync Status */
#syncStatus {
    margin-top: 10px;
    font-weight: bold;
    font-size: 18px;
    color: #00ff00;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
        align-items: center;
    }

    .panel {
        width: 90%;
    }
}
    </style>
</head>
<body>
    <h1>üéµ P2P Audio Sync</h1>
    
    <div class="container">
        <!-- Host Panel -->
        <div class="panel">
            <h2>üéß Host Controls</h2>
            <div class="id-box">
                üîë Your ID: <strong id="myId">Generating ID...</strong>
                <button class="copy-btn" onclick="copyID()">Copy</button>
            </div>
            <div class="qr-container" id="senderQr"></div>
            
            <input type="file" id="audioInput" accept="audio/*" hidden>
            <button onclick="document.getElementById('audioInput').click()">
                üéµ Select Audio File
            </button>
            
            <div class="audio-player">
                <audio id="mainAudio" controls></audio>
                <div class="audio-controls">
                    <button onclick="syncPlayback()" id="playBtn">‚ñ∂ Play</button>
                    <button onclick="pausePlayback()">‚è∏ Pause</button>
                </div>
            </div>
        </div>

        <!-- Listener Panel -->
        <div class="panel">
            <h2>üë• Listeners</h2>
            <button onclick="startQRScanner()" class="scan-btn">
                üì∑ Scan Host's QR Code
            </button>
            <div id="qrScanner" style="display:none"></div>
            
            <div class="audio-player">
                <audio id="clientAudio" controls></audio>
                <div id="syncStatus">üü¢ Synchronized</div>
            </div>
        </div>
    </div>

    <script>
    // Existing PeerJS and QR code setup remains same
    const CHUNK_SIZE = 64 * 1024; // 64 KB per chunk
const MAX_PARALLEL_CHUNKS = 5;
let receivedFiles = new Map();
let conn = null;
let peer = null;

// Initialize PeerJS
function initializePeer() {
    peer = new Peer();

    peer.on('open', (id) => {
        document.getElementById('myId').textContent = id;
        new QRCode(document.getElementById('senderQr'), id);
    });

    peer.on('connection', (connection) => {
        conn = connection;
        conn.on('data', handleIncomingData);
    });
}

// Copy ID Function
function copyID() {
    navigator.clipboard.writeText(document.getElementById('myId').textContent);
    alert('ID copied to clipboard!');
}

// QR Scanner Function
function startQRScanner() {
    const video = document.createElement('video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    document.getElementById('qrScanner').appendChild(video);
    document.getElementById('qrScanner').style.display = 'block';

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
            video.srcObject = stream;
            video.play();

            const scan = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);

                if (code) {
                    connectToPeer(code.data);
                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById('qrScanner').style.display = 'none';
                } else {
                    requestAnimationFrame(scan);
                }
            };
            scan();
        });
}

// Connect to Peer Function
function connectToPeer(peerId) {
    conn = peer.connect(peerId);
    conn.on('open', () => console.log('Connected to Host!'));
    conn.on('data', handleIncomingData);
}
    // Audio Sync Variables
    let audioElement = document.getElementById('mainAudio');
    let audioBlob = null;
    const SYNC_INTERVAL = 5000; // 5 second sync interval

    // Modified File Handling for Audio
    document.getElementById('audioInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file.type.startsWith('audio/')) {
            alert('Please select an audio file!');
            return;
        }
        
        // Send audio to peers
        transferAudioFile(file);
        
        // Set up local player
        const url = URL.createObjectURL(file);
        audioElement.src = url;
    });

    async function transferAudioFile(file) {
        const fileId = Date.now() + '-' + Math.random().toString(36).slice(2, 8);
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        
        // Send Metadata
        conn.send({
            type: 'audio-metadata',
            id: fileId,
            name: file.name,
            size: file.size,
            mime: file.type,
            totalChunks
        });

        // Send Chunks
        const chunks = Array.from({length: totalChunks}, (_,i) => i);
        while(chunks.length) {
            const batch = chunks.splice(0, MAX_PARALLEL_CHUNKS);
            await Promise.all(batch.map(i => sendAudioChunk(file, i, fileId)));
        }
    }

    async function sendAudioChunk(file, index, fileId) {
        return new Promise(resolve => {
            const reader = new FileReader();
            const start = index * CHUNK_SIZE;
            const end = start + CHUNK_SIZE;
            
            reader.onload = () => {
                conn.send({
                    type: 'audio-chunk',
                    id: fileId,
                    index,
                    data: reader.result
                });
                resolve();
            };
            reader.readAsArrayBuffer(file.slice(start, end));
        });
    }

    // Audio Sync Functions
    function syncPlayback() {
        const syncData = {
            type: 'sync',
            timestamp: Date.now(),
            currentTime: audioElement.currentTime,
            playbackRate: audioElement.playbackRate
        };
        
        conn.send(syncData);
        audioElement.play();
        setInterval(() => conn.send(syncData), SYNC_INTERVAL);
    }

    function pausePlayback() {
        conn.send({ type: 'pause', timestamp: Date.now() });
        audioElement.pause();
    }

    // Modified Data Handler
    function handleIncomingData(data) {
        if (data.type === 'audio-metadata') handleAudioMetadata(data);
        if (data.type === 'audio-chunk') handleAudioChunk(data);
        if (data.type === 'sync') handleSync(data);
        if (data.type === 'pause') handlePause(data);
    }

    function handleAudioMetadata(meta) {
        receivedFiles.set(meta.id, {
            name: meta.name,
            chunks: new Array(meta.totalChunks),
            received: 0,
            size: meta.size,
            mime: meta.mime
        });
    }

    function handleAudioChunk(chunk) {
        const file = receivedFiles.get(chunk.id);
        file.chunks[chunk.index] = chunk.data;
        file.received += chunk.data.byteLength;

        if(file.received >= file.size) {
            audioBlob = new Blob(file.chunks, { type: file.mime });
            document.getElementById('clientAudio').src = URL.createObjectURL(audioBlob);
        }
    }

    function handleSync(data) {
        const clientAudio = document.getElementById('clientAudio');
        const latency = Date.now() - data.timestamp;
        const targetTime = data.currentTime + (latency/1000);
        
        if(Math.abs(clientAudio.currentTime - targetTime) > 0.1) {
            clientAudio.currentTime = targetTime;
        }
        
        if(clientAudio.paused) clientAudio.play();
        clientAudio.playbackRate = data.playbackRate;
        updateSyncStatus();
    }

    function handlePause() {
        document.getElementById('clientAudio').pause();
        updateSyncStatus('‚è∏ Paused');
    }

    function updateSyncStatus(status = 'üü¢ Synchronized') {
        document.getElementById('syncStatus').textContent = status;
    }

    // Initialize
    window.addEventListener('load', initializePeer);
    </script>
</body>
</html>
