<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>ğŸµ P2P Audio Sync</title>
    
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        /* Existing styles remain same */
        
        /* Add Audio Player Styles */
        .audio-player {
            background: #002850;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .audio-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }
        
        .audio-controls button {
            width: auto;
            padding: 12px 25px;
        }
    </style>
</head>
<body>
    <h1>ğŸµ P2P Audio Sync</h1>
    
    <div class="container">
        <!-- Host Panel -->
        <div class="panel">
            <h2>ğŸ§ Host Controls</h2>
            <div class="id-box">
                ğŸ”‘ Your ID: <strong id="myId">Generating ID...</strong>
                <button class="copy-btn" onclick="copyID()">Copy</button>
            </div>
            <div class="qr-container" id="senderQr"></div>
            
            <input type="file" id="audioInput" accept="audio/*" hidden>
            <button onclick="document.getElementById('audioInput').click()">
                ğŸµ Select Audio File
            </button>
            
            <div class="audio-player">
                <audio id="mainAudio" controls></audio>
                <div class="audio-controls">
                    <button onclick="syncPlayback()" id="playBtn">â–¶ Play</button>
                    <button onclick="pausePlayback()">â¸ Pause</button>
                </div>
            </div>
        </div>

        <!-- Listener Panel -->
        <div class="panel">
            <h2>ğŸ‘¥ Listeners</h2>
            <button onclick="startQRScanner()" class="scan-btn">
                ğŸ“· Scan Host's QR Code
            </button>
            <div id="qrScanner" style="display:none"></div>
            
            <div class="audio-player">
                <audio id="clientAudio" controls></audio>
                <div id="syncStatus">ğŸŸ¢ Synchronized</div>
            </div>
        </div>
    </div>

    <script>
    // Existing PeerJS and QR code setup remains same
    
    // Audio Sync Variables
    let audioElement = document.getElementById('mainAudio');
    let audioBlob = null;
    const SYNC_INTERVAL = 5000; // 5 second sync interval

    // Modified File Handling for Audio
    document.getElementById('audioInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file.type.startsWith('audio/')) {
            alert('Please select an audio file!');
            return;
        }
        
        // Send audio to peers
        transferAudioFile(file);
        
        // Set up local player
        const url = URL.createObjectURL(file);
        audioElement.src = url;
    });

    async function transferAudioFile(file) {
        const fileId = Date.now() + '-' + Math.random().toString(36).slice(2, 8);
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        
        // Send Metadata
        conn.send({
            type: 'audio-metadata',
            id: fileId,
            name: file.name,
            size: file.size,
            mime: file.type,
            totalChunks
        });

        // Send Chunks
        const chunks = Array.from({length: totalChunks}, (_,i) => i);
        while(chunks.length) {
            const batch = chunks.splice(0, MAX_PARALLEL_CHUNKS);
            await Promise.all(batch.map(i => sendAudioChunk(file, i, fileId)));
        }
    }

    async function sendAudioChunk(file, index, fileId) {
        return new Promise(resolve => {
            const reader = new FileReader();
            const start = index * CHUNK_SIZE;
            const end = start + CHUNK_SIZE;
            
            reader.onload = () => {
                conn.send({
                    type: 'audio-chunk',
                    id: fileId,
                    index,
                    data: reader.result
                });
                resolve();
            };
            reader.readAsArrayBuffer(file.slice(start, end));
        });
    }

    // Audio Sync Functions
    function syncPlayback() {
        const syncData = {
            type: 'sync',
            timestamp: Date.now(),
            currentTime: audioElement.currentTime,
            playbackRate: audioElement.playbackRate
        };
        
        conn.send(syncData);
        audioElement.play();
        setInterval(() => conn.send(syncData), SYNC_INTERVAL);
    }

    function pausePlayback() {
        conn.send({ type: 'pause', timestamp: Date.now() });
        audioElement.pause();
    }

    // Modified Data Handler
    function handleIncomingData(data) {
        if (data.type === 'audio-metadata') handleAudioMetadata(data);
        if (data.type === 'audio-chunk') handleAudioChunk(data);
        if (data.type === 'sync') handleSync(data);
        if (data.type === 'pause') handlePause(data);
    }

    function handleAudioMetadata(meta) {
        receivedFiles.set(meta.id, {
            name: meta.name,
            chunks: new Array(meta.totalChunks),
            received: 0,
            size: meta.size,
            mime: meta.mime
        });
    }

    function handleAudioChunk(chunk) {
        const file = receivedFiles.get(chunk.id);
        file.chunks[chunk.index] = chunk.data;
        file.received += chunk.data.byteLength;

        if(file.received >= file.size) {
            audioBlob = new Blob(file.chunks, { type: file.mime });
            document.getElementById('clientAudio').src = URL.createObjectURL(audioBlob);
        }
    }

    function handleSync(data) {
        const clientAudio = document.getElementById('clientAudio');
        const latency = Date.now() - data.timestamp;
        const targetTime = data.currentTime + (latency/1000);
        
        if(Math.abs(clientAudio.currentTime - targetTime) > 0.1) {
            clientAudio.currentTime = targetTime;
        }
        
        if(clientAudio.paused) clientAudio.play();
        clientAudio.playbackRate = data.playbackRate;
        updateSyncStatus();
    }

    function handlePause() {
        document.getElementById('clientAudio').pause();
        updateSyncStatus('â¸ Paused');
    }

    function updateSyncStatus(status = 'ğŸŸ¢ Synchronized') {
        document.getElementById('syncStatus').textContent = status;
    }

    // Initialize
    window.addEventListener('load', initializePeer);
    </script>
</body>
</html>
